<!-- To see this working, copy/pull the whole frontend directory. 
     Open stockulator.html (or index.html) in your browser,
     type an ASX code into the search bar such as WOW.AX
     and hit enter. After about a second, the words:
     "Data dump here" should be changed to a string of the
     returned JSON file. If nothing happens, then Thomas has
     probably turned off the webserver, in which case you will
     need to ask him how that shit works (create an instance
     of the latest AMI, navigate to /home/ubuntu/stockulator
     and run webserver.py - then refresh stockulator.html in
     your browser and try search an ASX code again and it
     should give you the stock data).              -->

<!DOCTYPE html>
<html>
<head>

  <title>Stockulator</title>		<!-- NOT SURE WHY THE HEADER IS OVERRIDING THE TITLE -->
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="stylesheet" href="css/themes/StockulatorTheme.css" />
  <link rel="stylesheet" href="css/themes/jquery.mobile.icons.min.css" />
  <link rel="stylesheet" href="http://code.jquery.com/mobile/1.4.3/jquery.mobile.structure-1.4.3.min.css" /> 
  <link rel="stylesheet" href="http://fonts.googleapis.com/css?family=Quattrocento" />
  <link rel="stylesheet" href="css/themes/html5-pagination.css" />
  <script src="http://code.jquery.com/jquery-1.11.1.min.js"></script> 
  <script src="http://code.jquery.com/mobile/1.4.3/jquery.mobile-1.4.3.min.js"></script> 

</head>



<body onload=parseURL()> 

  <div data-role="page">

	  <div id="header" data-role="header" data-theme="a">
		  <h1>Stockulator</h1>
	  </div><!-- /header -->


	  <div id="content" data-role="content" data-theme="a">	

		  <input type="search" name="searchBar" id="searchbar" value="Enter ASX Code" data-theme="b" onkeyup="handle(event)" />	
		  <p>Information of searched stock goes here.</p>	

      <!-- Placeholder table, elements inserted via javascript -->
      <table id="myTable">
      </table>

		  <script>

        //Parser written by some dude on stack overflow
		    function parseURL() {
		      var url = document.URL;
          var queryStart = url.indexOf("?") + 1,
          queryEnd   = url.indexOf("#") + 1 || url.length + 1,
          query = url.slice(queryStart, queryEnd - 1),
          pairs = query.replace(/\+/g, " ").split("&"),
          parms = {}, i, n, v, nv;

          if (query === url || query === "") {
              return;
          }

          for (i = 0; i < pairs.length; i++) {
              nv = pairs[i].split("=");
              n = decodeURIComponent(nv[0]);
              v = decodeURIComponent(nv[1]);

              if (!parms.hasOwnProperty(n)) {
                  parms[n] = [];
              }

              parms[n].push(nv.length === 2 ? v : null);
          }
          
          //Only parse the first parameter which is the searched ASX code
          makeRequest(parms.code[0]);
		    }

        function handle(e) {

          
          if(e.keyCode == 13) {

            var code = $("#searchbar").val();
            console.log("ASX Code is " + code);

            //Need to choose here: easy way is to reload page with new search
            //query (no problems with back button but page needs to refresh).
            location.href = ("searchResults.html?code=" + code);
            
            //Hard way is to push new query into address bar without
            //actually reloading the page (but shit happens with the back
            //button and I cbs looking into it atm)
            //history.pushState({}, "uselessArg", "searchResults.html?code=" + code);
            //makeRequest(code);
            
          }
          
		    }

        function makeRequest(code){

          console.log("code is: " + code);

          $.getJSON("http://ec2-54-79-50-63.ap-southeast-2.compute.amazonaws.com:8080/data/" + code, function(data) {
            console.log("hi");
            console.log(data);        

            var table = document.getElementById("myTable");

            //Clean out the rows from a previous search if any
            var rowCount = table.rows.length;
            while(rowCount > 0) {
              table.deleteRow();
              rowCount--;
            }
            
            //String formatting
            var string = JSON.stringify(data);

            //Check for invalid search query
            if(string.indexOf("No such ticker symbol") > -1) {
              var currRow = table.insertRow();
              var data = document.createElement("TD");
              var text = document.createTextNode("Invalid ASX Code: " + code);
              data.appendChild(text);
              currRow.appendChild(data);
              return;
            }
            
            string = string.replace(/{/g, "");
            string = string.replace(/}/g, "");
            string = string.replace(/"/g, "");
            string = string.replace(/:/g, "  :  ");

            //Insert rows into table
            var rows = string.split(",");
                  
            for(var i = 0; i < rows.length; ++i) {
              var currRow = table.insertRow();

              console.log("row is: " + rows[i]);
              var data = document.createElement("TD");
              var text = document.createTextNode(rows[i]);
              data.appendChild(text);
              currRow.appendChild(data);           
              
            }

            
          });

        }        
		    
		  </script>


		  <!-- Need to get rid of rel="external" when we move from local to actual servers...I think -->
      <nav class="pagination">
        <ul>
        <li><a rel="prev" href="">&larr;</a></li>
        <li><a rel="external" rel="first" href="frontPage.html">1</a></li>
        <li><a rel="external" href="myPortfolio.html">2</a></li>
        <li><a rel="external" class="current" href="">3</a></li>
        <li><a rel="external" href="">4</a></li>
        <li><a rel="external" rel="last" href="">5</a></li>
        <li><a rel="next" href="">&rarr;</a></li>
        </ul>
      </nav>
		
	  </div><!-- /content -->

  </div><!-- /page -->

</body>
</html>
